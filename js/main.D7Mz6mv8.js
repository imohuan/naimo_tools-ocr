(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class B{canvas;ctx;settings;ocrResults;currentImage;scale;offsetX;offsetY;isDragging;lastMouseX;lastMouseY;naimo;ocrAPI;initDone;constructor(){this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.settings={},this.ocrResults=[],this.currentImage=null,this.scale=1,this.offsetX=0,this.offsetY=0,this.isDragging=!1,this.lastMouseX=0,this.lastMouseY=0,this.naimo=window.naimo,this.ocrAPI=window.ocrPluginAPI,this.initDone=!1,this.init()}async init(){await this.loadSettings(),this.setupEventListeners(),this.setupCanvas(),this.updateSettingsUI(),this.showPlaceholder(),this.initDone=!0}async waitInitDone(){return new Promise(t=>{const e=setInterval(()=>{this.initDone&&(clearInterval(e),t(!0))},100)})}async loadSettings(){try{const t=await this.naimo.storage.getItem("tencentSecretId")||"",e=await this.naimo.storage.getItem("tencentSecretKey")||"",s=localStorage.getItem("ocrPluginSettings"),i=s?JSON.parse(s):{};this.settings={tencentSecretId:t,tencentSecretKey:e,defaultSourceLang:"auto",defaultTargetLang:"zh",showOriginalImage:!0,showOriginalText:!0,showTranslatedText:!0,showBorder:!0,originalTextColor:"#FF0000",translatedTextColor:"#0000FF",originalTextSize:16,translatedTextSize:16,originalTextBold:!1,translatedTextBold:!1,originalTextUnderline:!1,translatedTextUnderline:!1,originalTextWrap:!0,originalTextOffsetX:0,originalTextOffsetY:0,translatedTextWrap:!0,translatedTextOffsetX:0,translatedTextOffsetY:20,textBackgroundOpacity:70,textBackgroundColor:"#000000",boxBorderColor:"#007AFF",boxBorderWidth:2,...i}}catch(t){console.error("åŠ è½½è®¾ç½®å¤±è´¥:",t)}}async saveSettings(){try{const t={...this.settings};delete t.tencentSecretId,delete t.tencentSecretKey,localStorage.setItem("ocrPluginSettings",JSON.stringify(t))}catch(t){console.error("ä¿å­˜è®¾ç½®å¤±è´¥:",t)}}async updateAPIStatus(){try{const t=document.getElementById("statusIndicator"),e=document.getElementById("statusText");if(!t||!e)return;const s=this.settings.tencentSecretId&&this.settings.tencentSecretId.trim(),i=this.settings.tencentSecretKey&&this.settings.tencentSecretKey.trim();s&&i?(t.textContent="ğŸŸ¢",e.textContent="å·²é…ç½®"):(t.textContent="ğŸ”´",e.textContent="æœªé…ç½®")}catch(t){console.error("æ›´æ–°APIçŠ¶æ€å¤±è´¥:",t)}}setupEventListeners(){document.getElementById("screenshotBtn")?.addEventListener("click",()=>this.takeScreenshot()),document.getElementById("openImageBtn")?.addEventListener("click",()=>this.openImage()),document.getElementById("resetViewBtn")?.addEventListener("click",()=>this.resetView()),document.getElementById("saveImageBtn")?.addEventListener("click",()=>this.saveImage()),document.getElementById("copyTextBtn")?.addEventListener("click",()=>this.copyText()),document.getElementById("settingsBtn")?.addEventListener("click",()=>this.showSettings()),document.getElementById("closeSettingsBtn")?.addEventListener("click",()=>this.hideSettings()),this.setupSettingListeners(),this.setupCanvasEvents(),this.setupPasteEvents(),window.addEventListener("resize",()=>this.resizeCanvas()),this.setupKeyboardShortcuts()}setupSettingListeners(){["sourceLang","targetLang","showOriginalImage","showOriginalText","showTranslatedText","showBorder","originalTextColor","translatedTextColor","originalTextSize","translatedTextSize","originalTextBold","translatedTextBold","originalTextUnderline","translatedTextUnderline","originalTextWrap","translatedTextWrap","originalTextOffsetX","originalTextOffsetY","translatedTextOffsetX","translatedTextOffsetY","textBackgroundOpacity","textBackgroundColor","boxBorderColor","boxBorderWidth"].forEach(e=>{const s=document.getElementById(e);s&&(s.addEventListener("change",i=>this.updateSetting(e,i)),s.addEventListener("input",i=>this.updateSetting(e,i)))})}updateSetting(t,e){const s=e.target;let i=s.type==="checkbox"?s.checked:s.value;const a={sourceLang:"defaultSourceLang",targetLang:"defaultTargetLang"}[t]||t;if((t.includes("Size")||t.includes("Offset")||t==="textBackgroundOpacity"||t==="boxBorderWidth")&&(i=parseInt(i)),this.settings[a]=i,this.saveSettings(),s.type==="range"){const g=document.getElementById(t+"Value");if(g){const o=t==="textBackgroundOpacity"?"%":"px";g.textContent=i+o}}this.currentImage&&this.redrawCanvas()}updateSettingsUI(){const t=document.getElementById("sourceLang"),e=document.getElementById("targetLang");t&&(t.value=this.settings.defaultSourceLang||"auto"),e&&(e.value=this.settings.defaultTargetLang||"zh"),["showOriginalImage","showOriginalText","showTranslatedText","showBorder"].forEach(l=>{const d=document.getElementById(l);d&&(d.checked=this.settings[l]??!0)});const i=document.getElementById("originalTextColor"),n=document.getElementById("translatedTextColor"),a=document.getElementById("originalTextSize"),g=document.getElementById("translatedTextSize");i&&(i.value=this.settings.originalTextColor||"#FF0000"),n&&(n.value=this.settings.translatedTextColor||"#0000FF"),a&&(a.value=String(this.settings.originalTextSize||16)),g&&(g.value=String(this.settings.translatedTextSize||16));const o=document.getElementById("originalTextOffsetX"),f=document.getElementById("originalTextOffsetY"),x=document.getElementById("translatedTextOffsetX"),c=document.getElementById("translatedTextOffsetY");o&&(o.value=String(this.settings.originalTextOffsetX||0)),f&&(f.value=String(this.settings.originalTextOffsetY||0)),x&&(x.value=String(this.settings.translatedTextOffsetX||0)),c&&(c.value=String(this.settings.translatedTextOffsetY||20)),["originalTextBold","originalTextUnderline","originalTextWrap","translatedTextBold","translatedTextUnderline","translatedTextWrap"].forEach(l=>{const d=document.getElementById(l);d&&(d.checked=this.settings[l]??!1)});const h=document.getElementById("textBackgroundColor"),w=document.getElementById("textBackgroundOpacity"),y=document.getElementById("boxBorderColor"),I=document.getElementById("boxBorderWidth");h&&(h.value=this.settings.textBackgroundColor||"#000000"),w&&(w.value=String(this.settings.textBackgroundOpacity||70)),y&&(y.value=this.settings.boxBorderColor||"#007AFF"),I&&(I.value=String(this.settings.boxBorderWidth||2)),[{id:"textBackgroundOpacity",unit:"%"},{id:"boxBorderWidth",unit:"px"}].forEach(({id:l,unit:d})=>{const T=document.getElementById(l+"Value");T&&(T.textContent=(this.settings[l]||0)+d)}),this.updateAPIStatus()}setupCanvas(){this.resizeCanvas()}showSettings(){document.getElementById("settingsDrawer")?.classList.add("open")}hideSettings(){document.getElementById("settingsDrawer")?.classList.remove("open")}toggleSettings(){document.getElementById("settingsDrawer")?.classList.toggle("open")}setupKeyboardShortcuts(){document.addEventListener("keydown",t=>{t.key==="Tab"?(t.preventDefault(),this.toggleSettings()):t.key==="Escape"&&this.hideSettings()})}showPlaceholder(){document.getElementById("placeholder")?.classList.remove("hidden")}hidePlaceholder(){document.getElementById("placeholder")?.classList.add("hidden")}setupPasteEvents(){document.addEventListener("paste",t=>this.handlePaste(t)),this.canvas.setAttribute("tabindex","0"),this.canvas.addEventListener("click",()=>{this.canvas.focus()})}async handlePaste(t){t.preventDefault();const e=t.clipboardData?.items;if(e)for(let s=0;s<e.length;s++){const i=e[s];if(i.type.indexOf("image")!==-1){const n=i.getAsFile();if(n)try{this.showToast("æ­£åœ¨å¤„ç†ç²˜è´´çš„å›¾ç‰‡...");const a=await this.fileToBase64(n);await this.processImage(a),this.showToast("å›¾ç‰‡ç²˜è´´æˆåŠŸï¼","success")}catch(a){console.error("ç²˜è´´å›¾ç‰‡å¤±è´¥:",a),this.showError("ç²˜è´´å›¾ç‰‡å¤±è´¥: "+a.message)}break}}}fileToBase64(t){return new Promise((e,s)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=s,i.readAsDataURL(t)})}setupCanvasEvents(){this.canvas.addEventListener("wheel",t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1,s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,n=t.clientY-s.top;this.zoomAt(i,n,e)}),this.canvas.addEventListener("mousedown",t=>{this.isDragging=!0,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY,this.canvas.style.cursor="grabbing"}),this.canvas.addEventListener("mousemove",t=>{if(this.isDragging){const e=t.clientX-this.lastMouseX,s=t.clientY-this.lastMouseY;this.offsetX+=e,this.offsetY+=s,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY,this.redrawCanvas()}}),this.canvas.addEventListener("mouseup",()=>{this.isDragging=!1,this.canvas.style.cursor="grab"}),this.canvas.addEventListener("mouseleave",()=>{this.isDragging=!1,this.canvas.style.cursor="grab"})}resizeCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.redrawCanvas()}zoomAt(t,e,s){const i=this.scale;if(this.scale*=s,this.scale=Math.max(.1,Math.min(5,this.scale)),this.scale!==i){const n=this.scale/i;this.offsetX=t-n*(t-this.offsetX),this.offsetY=e-n*(e-this.offsetY),this.redrawCanvas()}}resetView(){this.scale=1,this.offsetX=0,this.offsetY=0,this.redrawCanvas()}async takeScreenshot(){try{if(this.showStatus("å‡†å¤‡æˆªå›¾...",!0),this.ocrAPI&&this.ocrAPI.takeScreenshot){const t=await this.ocrAPI.takeScreenshot();t?await this.processImage(t):this.showError("æˆªå›¾å–æ¶ˆæˆ–å¤±è´¥")}else this.showError("æˆªå›¾åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æ’ä»¶é…ç½®")}catch(t){this.showError("æˆªå›¾å¤±è´¥: "+t.message)}finally{this.hideStatus()}}async openImage(){try{if(this.ocrAPI&&this.ocrAPI.selectImage){const t=await this.ocrAPI.selectImage();t&&await this.processImage(t)}else this.showError("é€‰æ‹©å›¾ç‰‡åŠŸèƒ½ä¸å¯ç”¨")}catch(t){console.error("æ‰“å¼€å›¾ç‰‡å¤±è´¥:",t),this.showError("æ‰“å¼€å›¾ç‰‡å¤±è´¥: "+t.message)}}async processImage(t){try{this.showStatus("æ­£åœ¨åŠ è½½å›¾ç‰‡...",!0);const e=new Image;e.onload=async()=>{this.currentImage=e,this.hidePlaceholder(),this.resetView(),this.redrawCanvas();const s=document.getElementById("resetViewBtn"),i=document.getElementById("saveImageBtn");s&&(s.disabled=!1),i&&(i.disabled=!1),await this.performOCR(t)},e.onerror=()=>{this.showError("å›¾ç‰‡åŠ è½½å¤±è´¥")},e.src=t}catch(e){console.error("å¤„ç†å›¾ç‰‡å¤±è´¥:",e),this.showError("å¤„ç†å›¾ç‰‡å¤±è´¥: "+e.message)}}async performOCR(t){try{if(this.showStatus("æ­£åœ¨è¯†åˆ«æ–‡å­—...",!0),!this.settings.tencentSecretId||!this.settings.tencentSecretKey){this.showError("è¯·å…ˆé…ç½®è…¾è®¯äº‘APIå¯†é’¥");return}if(this.ocrAPI&&this.ocrAPI.performOCR){const e=await this.ocrAPI.performOCR({imageData:t,secretId:this.settings.tencentSecretId,secretKey:this.settings.tencentSecretKey,sourceLang:this.settings.defaultSourceLang,targetLang:this.settings.defaultTargetLang});if(e&&e.length>0){this.ocrResults=e,this.redrawCanvas();const s=document.getElementById("copyTextBtn");s&&(s.disabled=!1),this.showSuccess(`æˆåŠŸè¯†åˆ« ${e.length} ä¸ªæ–‡æœ¬åŒºåŸŸ`)}else this.showError("æœªè¯†åˆ«åˆ°ä»»ä½•æ–‡å­—")}else this.showError("OCRåŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æ’ä»¶é…ç½®")}catch(e){console.error("OCRè¯†åˆ«å¤±è´¥:",e),this.showError("OCRè¯†åˆ«å¤±è´¥: "+e.message)}finally{this.hideStatus()}}redrawCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.currentImage&&(this.ctx.save(),this.ctx.translate(this.offsetX,this.offsetY),this.ctx.scale(this.scale,this.scale),this.settings.showOriginalImage&&this.ctx.drawImage(this.currentImage,0,0),this.drawOCRResults(),this.ctx.restore())}drawOCRResults(){if(!this.ocrResults||this.ocrResults.length===0)return;const t=this.settings.showOriginalText,e=this.settings.showTranslatedText;!t&&!e||this.ocrResults.forEach(s=>{if(!s.polygon||s.polygon.length===0)return;const i=Math.min(...s.polygon.map(r=>r.X||0)),n=Math.max(...s.polygon.map(r=>r.X||0)),a=Math.min(...s.polygon.map(r=>r.Y||0)),g=Math.max(...s.polygon.map(r=>r.Y||0)),o=n-i,f=g-a,x=this.settings.showBorder===!0,c=parseInt(String(this.settings.translatedTextOffsetX))||0,u=parseInt(String(this.settings.translatedTextOffsetY))||0,h=(this.settings.textBackgroundOpacity||0)/100;if(x&&h>0){const r=this.settings.textBackgroundColor||"#000000",l=parseInt(r.slice(1,3),16),d=parseInt(r.slice(3,5),16),T=parseInt(r.slice(5,7),16);this.ctx.fillStyle=`rgba(${l}, ${d}, ${T}, ${h})`,this.ctx.fillRect(i+c,a+u,o,f)}const w=this.settings.boxBorderWidth||2;x&&w>0&&(this.ctx.strokeStyle=this.settings.boxBorderColor||"#007AFF",this.ctx.lineWidth=w,this.ctx.strokeRect(i+c,a+u,o,f));const y=i+5,I=a+Math.max(this.settings.originalTextSize||16,this.settings.translatedTextSize||16);if(t&&s.originalText){const r=parseInt(String(this.settings.originalTextOffsetX))||0,l=parseInt(String(this.settings.originalTextOffsetY))||0,d=Math.max(0,y+r),T=Math.max(this.settings.originalTextSize||16,I+l);this.drawText(s.originalText,d,T,Math.max(100,o-10),this.settings.originalTextColor||"#FF0000",this.settings.originalTextSize||16,this.settings.originalTextBold||!1,this.settings.originalTextUnderline||!1,this.settings.originalTextWrap!==!1)}if(e&&s.translatedText){const r=parseInt(String(this.settings.translatedTextOffsetX))||0,l=parseInt(String(this.settings.translatedTextOffsetY))||0,d=Math.max(0,y+r),T=Math.max(this.settings.translatedTextSize||16,I+l);this.drawText(s.translatedText,d,T,Math.max(100,o-10),this.settings.translatedTextColor||"#0000FF",this.settings.translatedTextSize||16,this.settings.translatedTextBold||!1,this.settings.translatedTextUnderline||!1,this.settings.translatedTextWrap!==!1)}})}drawText(t,e,s,i,n,a,g,o,f){if(this.ctx.fillStyle=n,this.ctx.font=`${g?"bold":"normal"} ${a}px Arial, sans-serif`,this.ctx.strokeStyle=n,this.ctx.lineWidth=1,!f){if(this.ctx.fillText(t,e,s),o){const h=this.ctx.measureText(t).width;this.ctx.beginPath(),this.ctx.moveTo(e,s+2),this.ctx.lineTo(e+h,s+2),this.ctx.stroke()}return}const x=t.split("");let c="",u=s;for(let h=0;h<x.length;h++){const w=c+x[h];this.ctx.measureText(w).width>i&&h>0?(this.ctx.fillText(c,e,u),o&&(this.ctx.beginPath(),this.ctx.moveTo(e,u+2),this.ctx.lineTo(e+this.ctx.measureText(c).width,u+2),this.ctx.strokeStyle=n,this.ctx.stroke()),c=x[h],u+=a+4):c=w}c&&(this.ctx.fillText(c,e,u),o&&(this.ctx.beginPath(),this.ctx.moveTo(e,u+2),this.ctx.lineTo(e+this.ctx.measureText(c).width,u+2),this.ctx.strokeStyle=n,this.ctx.stroke()))}async saveImage(){try{if(!this.currentImage){this.showError("æ²¡æœ‰å¯ä¿å­˜çš„å›¾ç‰‡");return}const t=document.createElement("canvas");t.width=this.currentImage.width,t.height=this.currentImage.height;const e=t.getContext("2d");e.drawImage(this.currentImage,0,0);const s=this.scale,i=this.offsetX,n=this.offsetY;this.scale=1,this.offsetX=0,this.offsetY=0;const a=this.ctx;this.ctx=e,this.drawOCRResults(),this.ctx=a,this.scale=s,this.offsetX=i,this.offsetY=n,t.toBlob(g=>{if(g){const o=URL.createObjectURL(g),f=document.createElement("a");f.href=o,f.download=`ocr_result_${Date.now()}.png`,f.click(),URL.revokeObjectURL(o),this.showSuccess("å›¾ç‰‡å·²ä¿å­˜")}})}catch(t){console.error("ä¿å­˜å›¾ç‰‡å¤±è´¥:",t),this.showError("ä¿å­˜å›¾ç‰‡å¤±è´¥: "+t.message)}}async copyText(){try{if(!this.ocrResults||this.ocrResults.length===0){this.showError("æ²¡æœ‰å¯å¤åˆ¶çš„æ–‡æœ¬");return}const t=this.settings.showOriginalText,e=this.settings.showTranslatedText;let s="";this.ocrResults.forEach((i,n)=>{n>0&&(s+=`

`),t&&i.originalText&&(s+=`åŸæ–‡: ${i.originalText}`),e&&i.translatedText&&(t&&(s+=`
`),s+=`è¯‘æ–‡: ${i.translatedText}`)}),await this.naimo.clipboard.writeText(s),this.showSuccess("æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(t){console.error("å¤åˆ¶æ–‡æœ¬å¤±è´¥:",t),this.showError("å¤åˆ¶æ–‡æœ¬å¤±è´¥: "+t.message)}}showStatus(t,e=!1){if(console.log("çŠ¶æ€:",t),this.showToast(t),e){const s=document.getElementById("loading");s&&(s.style.display="block")}}hideStatus(){console.log("éšè—çŠ¶æ€");const t=document.getElementById("loading");t&&(t.style.display="none")}showError(t){console.error("é”™è¯¯:",t),this.showToast(t,"error"),this.hideStatus()}showSuccess(t){console.log("æˆåŠŸ:",t),this.showToast(t,"success")}showToast(t,e="info"){const s=document.getElementById("statusToast");s&&(s.textContent=t,s.className="fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-lg opacity-0 transition-opacity duration-300",e==="error"?s.classList.add("bg-red-500","text-white"):e==="success"?s.classList.add("bg-green-500","text-white"):s.classList.add("bg-white","text-gray-800"),setTimeout(()=>{s.classList.remove("opacity-0"),s.classList.add("opacity-100")},10),setTimeout(()=>{s.classList.remove("opacity-100"),s.classList.add("opacity-0")},3e3))}}let p=null;async function S(){console.log("åº”ç”¨åˆå§‹åŒ–...");try{p=new B,window.naimo.log.info("OCRç¿»è¯‘æ’ä»¶åˆå§‹åŒ–å®Œæˆ")}catch(m){console.error("åˆå§‹åŒ–å¤±è´¥:",m),window.naimo.log.error("OCRç¿»è¯‘æ’ä»¶åˆå§‹åŒ–å¤±è´¥",m)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S();const v=async()=>{await new Promise(m=>{const t=setInterval(()=>{p&&(clearInterval(t),m())},100)}),await p.waitInitDone()};naimo.onEnter(async m=>{if(m.fullPath.split(":").slice(1).join(":")==="screenshot-ocr-translate"){await v(),await p.takeScreenshot();return}try{const e=m?.files?.[0]?.path;if(!e){console.log("æœªæ¥æ”¶åˆ°å›¾ç‰‡è·¯å¾„");return}console.log("æ¥æ”¶åˆ°å›¾ç‰‡è·¯å¾„:",e),await v();const s=await window.ocrPluginAPI.loadLocalImage(e);s&&p?(await p.processImage(s),console.log("å›¾ç‰‡å·²æˆåŠŸåŠ è½½å¹¶æ˜¾ç¤ºåœ¨çª—å£ä¸­"),naimo.log.info("å›¾ç‰‡å·²åŠ è½½åˆ°çª—å£")):(console.error("æ— æ³•è·å–å›¾ç‰‡æ•°æ®"),naimo.log.error("æ— æ³•è·å–å›¾ç‰‡æ•°æ®"))}catch(e){console.error("å¤„ç†å¤–éƒ¨å›¾ç‰‡å¤±è´¥:",e),naimo.log.error("å¤„ç†å¤–éƒ¨å›¾ç‰‡å¤±è´¥",e)}});
